<!DOCTYPE html>
<html>
<head>
  <title>Effects Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const parseCondition = (condition) => {
        const match = condition.match(/(.+?)\s+(=|!=|in|not in)\s+(\[.*?\]|[^\[]+)/);
        if (!match) return () => true;
        const [, field, operator, valueRaw] = match.map(s => s.trim());
        const value = valueRaw.startsWith('[') ? JSON.parse(valueRaw.replace(/'/g, '"')) : valueRaw;
        return () => {
          const actual = document.querySelector(`[name="${field}"]`)?.value;
          if (operator === '=') return actual === value;
          if (operator === '!=') return actual !== value;
          if (operator === 'in') return Array.isArray(value) && value.includes(actual);
          if (operator === 'not in') return Array.isArray(value) && !value.includes(actual);
          return true;
        };
      };

      const updateVisibility = () => {
        document.querySelectorAll('[data-visible-if]').forEach(group => {
          const condition = group.getAttribute('data-visible-if');
          const visible = parseCondition(condition)();
          group.style.display = visible ? '' : 'none';
        });
      };

      document.querySelectorAll('select, input').forEach(input => {
        input.addEventListener('change', updateVisibility);
      });

      updateVisibility();
    });
  </script>
</head>
<body class="p-4">
  <div class="d-flex">
    {% include 'sidebar.html' %}
    <div class="flex-grow-1 p-4">
      <h1 class="mb-4">Manage Effects</h1>
      {% import "macros.html" as macros %}
      <form method="post" class="row g-3">
        {% for field, definition in schema.items() %}
          {% set condition = definition.visible_if if 'visible_if' in definition else None %}
          <div class="col-md-6" {% if condition %}data-visible-if="{{ condition | e }}"{% endif %}>
            {{ macros.render_field(field, definition, '', '') }}
          </div>
        {% endfor %}
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Add Effect</button>
        </div>
      </form>
      <hr class="my-5">
      <h2>Existing Effects</h2>
      <ul class="list-group">
        {% for effect in effects %}
          <li class="list-group-item bg-dark text-light">{{ effect.effect_name }} - {{ effect.description }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</body>
</html>
